trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'azure-container-registry'
  imageRepository: 'ecommerce-cajamarca'
  containerRegistry: 'ecommercecajamarca.azurecr.io'
  resourceGroup: 'rg-ecommerce-cajamarca'
  location: 'eastus'
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build and Push Images
  jobs:
  - job: BuildAndPush
    displayName: Build and Push to ACR
    steps:
    - task: Docker@2
      displayName: 'Build and Push Backend'
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageRepository)-backend'
        command: 'buildAndPush'
        Dockerfile: 'E-comerce_Mujeres_Cajamarca/Dockerfile'
        buildContext: 'E-comerce_Mujeres_Cajamarca'
        tags: |
          $(tag)
          latest
          
    - task: Docker@2
      displayName: 'Build and Push Frontend'
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageRepository)-frontend'
        command: 'buildAndPush'
        Dockerfile: 'ecommerceCajamrca-frontend/Dockerfile'
        buildContext: 'ecommerceCajamrca-frontend'
        tags: |
          $(tag)
          latest

- stage: Deploy
  displayName: Deploy to Azure
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployToAzure
    displayName: Deploy to Azure Container Instances
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            displayName: 'Deploy Infrastructure and Apps'
            inputs:
              azureSubscription: 'azure-service-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Crear grupo de recursos
                az group create --name $(resourceGroup) --location $(location)
                
                # Crear PostgreSQL
                az postgres flexible-server create \
                  --resource-group $(resourceGroup) \
                  --name ecommerce-db-$(tag) \
                  --location $(location) \
                  --admin-user postgres \
                  --admin-password 'CajamarcaDB2024!' \
                  --sku-name Standard_B1ms \
                  --public-access 0.0.0.0 \
                  --storage-size 32
                
                # Desplegar Backend
                az container create \
                  --resource-group $(resourceGroup) \
                  --name ecommerce-backend \
                  --image $(containerRegistry)/$(imageRepository)-backend:$(tag) \
                  --registry-login-server $(containerRegistry) \
                  --registry-username $(containerRegistry) \
                  --registry-password $(az acr credential show --name ecommercecajamarca --query "passwords[0].value" -o tsv) \
                  --dns-name-label ecommerce-backend-$(tag) \
                  --ports 8085 \
                  --environment-variables \
                    SPRING_DATASOURCE_URL="jdbc:postgresql://ecommerce-db-$(tag).postgres.database.azure.com:5432/postgres" \
                    SPRING_DATASOURCE_USERNAME="postgres" \
                    SPRING_DATASOURCE_PASSWORD="CajamarcaDB2024!" \
                    SPRING_JPA_HIBERNATE_DDL_AUTO="update"
                
                # Desplegar Frontend
                az container create \
                  --resource-group $(resourceGroup) \
                  --name ecommerce-frontend \
                  --image $(containerRegistry)/$(imageRepository)-frontend:$(tag) \
                  --registry-login-server $(containerRegistry) \
                  --registry-username $(containerRegistry) \
                  --registry-password $(az acr credential show --name ecommercecajamarca --query "passwords[0].value" -o tsv) \
                  --dns-name-label ecommerce-frontend-$(tag) \
                  --ports 3000
                
                echo "Deployment completed!"
                echo "Frontend URL: http://ecommerce-frontend-$(tag).$(location).azurecontainer.io:3000"
                echo "Backend URL: http://ecommerce-backend-$(tag).$(location).azurecontainer.io:8085"